<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <title>Chat WebSocket</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <style>
      h4 {
          margin-top: 20px;
      }

      #sendGptMessageBtn {
          display: none;
      }

      #unReadyBtn {
          display: none;
      }

      #conversationBox {
          margin-bottom: 20px;
      }

      .conversation-list-item {
          /*background-color: white;*/
          /*border-style: solid;*/
          /*border-width: medium;*/
          margin-bottom: 10px;
      }

      .conversation-list-item-username {

      }

      .conversation-list-item-content {

      }

      .twenty-game-ask-conversation .conversation-list-item-content {
          font-weight: bold;
      }

      .twenty-game-from-gpt-conversation .conversation-list-item-content {
          font-weight: bold;
      }

      .conversation-list-item-created-at {
          font-size: 0.8em;
      }

      .twenty-game-ask-conversation, .twenty-game-from-gpt-conversation {
          border-left: red solid 3px;
      }

      /*.twenty-game-from-gpt-conversation {*/
      /*    border-bottom: green solid 4px;*/
      /*}*/

      .myConversation {
          background-color: lightblue;
          /*border-color: lightblue;*/
      }

      .otherConversation {
          background-color: lightgray;
          /*border-color: lightgray;*/
      }

      .gptConversation {
          background-color: lightgreen;
          /*border-color: lightgreen;*/
      }

      .systemConversation {
          background-color: white;
          /*border-color: black;*/
      }

      .twenty-asking-conversation-input {
          border: green solid 3px;
      }


  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  <script type="text/javascript" th:inline="javascript">

      /*<![CDATA[*/
      let thCurrentMember = [[${currentMember}]];
      /*]]>*/

      // STOMP 변수
      let stompClient = null;
      let currentSubscription = null;

      // 서버에서 내려주는 TwentyMessageDto 구조. (사용X)
      const TwentyMessageDto = {
          roomId: 0,
          userId: 0,
          type: '',
          username: '',
          content: '',
          createdAt: '',
          isGptChat: false,       // Gpt 와의 대화인지 여부, 프론트에서 전달

          gptUuid: null,            // GPT 의 UUID, UUID(8)
          isTwentyStart: false,    // 시작시, 시작성공여부
          orderArray: null,        // 시작시, 순서 정하기 위해 섞은 배열
          order: 0,                // 진행 시, user 자신의 순서
          twentyNext: 0,         // 진행 시, gpt 가 내려주는 다음 순서
          twentyWinner: ''          //  종료 시, 승자의 username
      }


      document.addEventListener('DOMContentLoaded', function () {

          // DOM 요소 탐색
          let usernameInput = document.getElementById('usernameInput');
          let contentInput = document.getElementById('contentInput');
          let roomData = document.getElementById('roomId');

          let conversationInput = document.getElementById('conversationInput');
          let conversationList = document.getElementById('conversationList');

          // 이벤트 리스터용 DOM 요소 탐색
          let memberListBtn = document.getElementById('memberListBtn');
          let sendMessageBtn = document.getElementById('sendMessageBtn');
          let sendGptMessageBtn = document.getElementById('sendGptMessageBtn');
          let unSubscribeBtn = document.getElementById('unSubscribeBtn');
          let startBtn = document.getElementById('startBtn');
          let readyBtn = document.getElementById('readyBtn');
          let unReadyBtn = document.getElementById('unReadyBtn');
          let inputStatus = document.getElementById('inputStatus');

          // connect connectInit()
          let sendUrl = '';
          let subUrl = '';
          let currentRoomId = '';
          let currentUserId = '';
          let currentUsername = '';

          // 필요시 초기화될 변수
          let readyUserCount = 0;
          let allUserCount = 0;
          let isCurrentUserReady = false;
          let isTwentyStart = false; // 서버에서 스무고개 시작 여부 확인후 전송됨
          let orderArray = null; // 서버에서 스무고개 시작후 내려준 순서결정용 배열
          let myMemberOrder = -1; // 멤버 순서 (syncMemberList 에서 갱신)
          let myTwentyOrder = -1; // 스무고개 순서 (TWENTY_GAME_START 메시지 오면 갱신)
          let currentGptUuid; // 스무고개 START 하면 서버에서 uuid 받아서 초기화
          let twentyWinner;
          let currentQuestionCount = 0; // 메시지에 표시하기위해 작성됨
          let remainingOrderCount; // 내 차례까지 남은 횟수. readyUserCount 를 대입한뒤 GPT_ANSWER 마다 1씩감소
          let isPlaying = false; // 게임중인지 여부. TWENTY_GAME_START, TWENTY_GAME_END 에서 갱신, sync 에서 사용

          // 초기 Connect 호출
          connect();

          // eventListener =====================================================================================

          window.addEventListener("beforeunload", function (event) {
              console.log('event.beforeunload');
              disconnect();
          });

          memberListBtn.addEventListener('click', syncMemberList.bind(null, isPlaying));

          sendMessageBtn.addEventListener('click', sendMessage.bind(null, 'CHAT'));
          sendGptMessageBtn.addEventListener('click', sendMessage.bind(null, 'TWENTY_GAME_ASK'));

          contentInput.addEventListener('keypress', function (e) { if (e.key === 'Enter' && !e.shiftKey) sendMessageBtn.click() });
          contentInput.addEventListener('keypress', function (e) { if (e.key === 'Enter' && e.shiftKey && isPlaying) sendGptMessageBtn.click() });

          unSubscribeBtn.addEventListener('click', unSubscribe);

          startBtn.addEventListener('click', sendMessage.bind(null, 'TWENTY_GAME_START'));


          document.querySelectorAll('.changeReadyBtn').forEach(btn => {
              let toReady = btn.dataset.toready;
              btn.addEventListener('click', sendMessage.bind(null, toReady == 'true' ? 'TWENTY_GAME_READY' : 'TWENTY_GAME_UNREADY'))
          });

          // function ===============================================================================================

          // connect 전 상태 초기화
          function connectInit() {
              currentUsername = usernameInput.value;
              currentUserId = document.getElementById('userId').value;
              currentRoomId = roomData.dataset.roomid;

              sendUrl = '/app/twenty-game/' + currentRoomId;
              subUrl = '/topic/twenty-game/' + currentRoomId;

              if (thCurrentMember != null) {
                  if (thCurrentMember.roomOwner == true) startBtn.removeAttribute('disabled');
                  syncMemberList(isPlaying);
              }
          }

          // 소켓 연결
          function connect() {

              connectInit();

              // 소켓연결
              let socket = new SockJS('/chat');

              // STOMP 연결
              let headers = setConnectHeaders();
              stompClient = Stomp.over(socket);

              stompClient.connect(headers, function (frame) {
                  setConnected(true);  // 연결후 html 조정
                  console.log('Connected: ' + frame);

                  // 서버의 endpoint 에 연결 후 메시지 수신마다 콜백실행 (responseMessage 은 서버에서 전송한 메시지)
                  currentSubscription = stompClient.subscribe(subUrl, function (responseMessageDto) {
                      let responseMessage = JSON.parse(responseMessageDto.body)
                      processMessage(responseMessage);
                  });
              });
          }

// 사용자의 구독해제
          function unSubscribe() {
              currentSubscription.unsubscribe();
              // index 로 보냄. (뒤로가기 불가)
              location.replace('/');
          }

          function disconnect() {
              if (stompClient != null) {
                  stompClient.disconnect(function () {});
              }
              setConnected(false);
              console.log("Disconnected");
          }

// 연결 여부에 따라 입력 및 스타일 조정
          function setConnected(connected) {
              unSubscribeBtn.disabled = !connected;
              conversationInput.style.visibility
                  = connected ? 'visible' : 'hidden';
          }

          /**
           * 메시지의 header 설정하는 함수
           */
          function setConnectHeaders() {
              let headers = {
                  "containsNativeHeader": true,
                  "currentRoomId": currentRoomId,
                  "subUrl": subUrl
              }
              return headers;
          }

// 메시지 전송
          function sendMessage(chatMessageType) {
              let usernameVal = usernameInput.value;
              let contentVal = contentInput.value;
              let isGptChat = chatMessageType == 'TWENTY_GAME_START' ||
              chatMessageType == 'TWENTY_GAME_ASK' ||
              chatMessageType == 'TWENTY_GAME_ANSWER'
                  ? true : false;

              // 스무고개 게임 시작되면 문제 번호 붙이기.
              if (isGptChat) {
                  contentVal = currentQuestionCount + ". " + contentVal;
              }

              let sendMessageDto = {
                  'roomId': thCurrentMember.roomId,
                  'userId': thCurrentMember.userId,
                  'type': chatMessageType,
                  'username': usernameVal,
                  'content': contentVal,
                  'createdAt': '',
                  'isGptChat': isGptChat,       // Gpt 와의 대화인지 여부, 프론트에서 전달

                  'gptUuid': currentGptUuid,            // GPT 의 UUID, UUID(8)
                  'order': myTwentyOrder,                // 진행 시, user 자신의 순서

                  // 클라이언트의 값은 보내는 의미가 없는 필드들
                  'isTwentyStart': isTwentyStart,    // 시작성공여부
                  'orderArray': orderArray,        // 시작시, 순서 정하기 위해 섞은 배열
                  'twentyNext': 0,         // 진행 시, gpt 가 내려주는 다음 순서
                  'twentyWinner': '',          //  종료 시, 승자의 username
              }
              // headers = {}
              stompClient.send(sendUrl, {}, JSON.stringify(sendMessageDto));
          }

// 메시지 수신 처리
          function processMessage(responseMessage) {
              // GPT_PROCESSING 메시지 삭제
              document.querySelectorAll('.gpt-processing').forEach(item => item.remove());

              let needShowMessage = true;
              switch (responseMessage.type) {
                  case 'ENTER':
                      break;

                  case 'LEAVE':
                      break;

                  case 'TWENTY_GAME_READY':
                      // 상태처리
                      isCurrentUserReady = responseMessage.userId == currentUserId ? true : isCurrentUserReady;

                      // 버튼처리
                      changeReadyBtnStyle(isCurrentUserReady);

                      document.getElementById('memberListBtn').click(); // 멤버리스트 갱신
                      needShowMessage = false; break;

                  case 'TWENTY_GAME_UNREADY':
                      // 상태처리
                      isCurrentUserReady = responseMessage.userId == currentUserId ? false : isCurrentUserReady;

                      // 버튼처리
                      changeReadyBtnStyle(isCurrentUserReady);

                      document.getElementById('memberListBtn').click(); // 멤버리스트 갱신
                      needShowMessage = false; break;

                  case 'TWENTY_GAME_START':
                      // 상태처리
                      currentGptUuid = responseMessage.gptUuid;
                      myTwentyOrder = responseMessage.orderArray[myMemberOrder];
                      isPlaying = true;

                      // 버튼 처리
                      disableAllMenuBtn();
                      sendGptMessageBtn.style.display = 'block';

                      needShowMessage = false; break;

                  case 'TWENTY_GAME_END' :
                      // 상태처리
                      isPlaying = false;
                      twentyWinner = responseMessage.twentyWinner;
                      alert(twentyWinner + " 승리");

                      // 버튼처리
                      enableAllMenuBtn();
                      changeReadyBtnStyle(isCurrentUserReady);
                      sendGptMessageBtn.style.display = 'none';

                      // 스타일처리
                      inputStatus.innerText = '대기중';
                      conversationInput.classList.remove('twenty-asking-conversation-input');

                      document.getElementById('memberListBtn').click(); // 멤버리스트 갱신
                      break;

                  case 'TWENTY_GAME_ERROR':
                      break;

                  case 'GPT_PROCESSING':
                      sendGptMessageBtn.disabled = true;
                      break;

                  case 'TWENTY_FROM_GPT':
                      currentQuestionCount++; // 질문 카운트 증가

                      // 내가 질문할 차례인 경우
                      if (responseMessage.twentyNext == myTwentyOrder) { // 질문해야할 사람의 order 가 전송된다.
                          // 상태처리
                          remainingOrderCount = readyUserCount; // 내차례가 돌아오면, 남은차례 초기화
                          console.log('remainingOrderCount : ' + remainingOrderCount);
                          console.log('readyUserCount : ' + readyUserCount);

                          // 버튼처리
                          sendGptMessageBtn.disabled = false;

                          // 스타일처리
                          conversationInput.classList.add('twenty-asking-conversation-input');// 질문박스 하이라이트
                          contentInput.setAttribute('placeholder', '그것은 OOO 입니까?');
                          inputStatus.innerText = '스무고개 질문 차례입니다';

                          // 내가 질문한게 아닌 경우
                      } else {
                          // 상태처리
                          remainingOrderCount--;

                          // 버튼처리
                          sendGptMessageBtn.disabled = true;

                          // 스타일처리
                          conversationInput.classList.remove('twenty-asking-conversation-input');
                          contentInput.setAttribute('placeholder', '채팅 메시지 입력');
                          inputStatus.innerText = '내 차례까지 앞으로 ' + remainingOrderCount;
                      }

              } //switch

              if (needShowMessage) showMessage(responseMessage);
          }

          // 메시지 화면 출력
          function showMessage(chatMessage) {
              // <li> <span username> <span content> <span createdAt> </li>
              let listItem = document.createElement('li');
              let username = document.createElement('span');
              let content = document.createElement('span');
              let createdAt = document.createElement('span');

              let colorClassName = determineConversationColorClass(chatMessage.username);
              let conversationHighlightClassName = determineConversationTwentyHighlightClass(chatMessage.type);

              if (chatMessage.type == 'GPT_PROCESSING') listItem.classList.add('gpt-processing');
              listItem.classList.add('list-group-item', 'conversation-list-item', colorClassName, conversationHighlightClassName);

              username.textContent = chatMessage.username + ": ";
              username.classList.add('conversation-list-item-username');
              listItem.appendChild(username)

              content.textContent = chatMessage.content;
              content.classList.add('conversation-list-item-content');
              listItem.appendChild(content)

              createdAt.textContent = " (" + convertTime(chatMessage.createdAt) + ")";
              createdAt.classList.add('conversation-list-item-created-at');

              listItem.appendChild(createdAt);
              conversationList.appendChild(listItem);

              contentInput.value = '';
          }

          function determineConversationColorClass(username) {
              let className = "";
              if (username == 'assistant') {
                  className = "gptConversation";
              } else if (username == 'SYSTEM') {
                  className = "systemConversation";
              } else if (username == currentUsername) {
                  className = "myConversation";
              } else {
                  // 다른 user
                  className = "otherConversation";
              }
              return className;
          }

          /**
           * 스무고개 ask, answer 메시지의 강조색상 클래스 결정
           */
          function determineConversationTwentyHighlightClass(messageType) {
              let className = "none";
              if (messageType == 'TWENTY_GAME_ASK') {
                  className = "twenty-game-ask-conversation"
              }
              if (messageType == 'TWENTY_FROM_GPT') {
                  className = "twenty-game-from-gpt-conversation"
              }
              return className;
          }

          function convertTime(time) {
              // time = "2023-06-07T16:23:47";
              const dateTime = new Date(time); // 원본 시간을 Date 객체로 변환, "2023-06-07T07:23:47.000Z"

              // slice(-2) : 마지막 두글자
              // ex) minute = 3, '0' + minute = '03', ('0' + minute).slice(-2) = '03'
              // ex2) minute = 13, '0' + minute = '013', ('0' + minute).slice(-2) = '13'

              const year = dateTime.getFullYear().toString().slice(2); // 연도에서 뒤의 두자리만 가져옴
              const month = ('0' + (dateTime.getMonth() + 1)).slice(-2); // 월을 가져오고, 1을 더한 뒤, 앞에 0을 붙임
              const day = ('0' + dateTime.getDate()).slice(-2); // 일을 가져오고, 앞에 0을 붙임
              const hour = ('0' + dateTime.getHours()).slice(-2); // 시간을 가져오고, 앞에 0을 붙임
              const minute = ('0' + dateTime.getMinutes()).slice(-2); // 분을 가져오고, 앞에 0을 붙임
              const second = ('0' + dateTime.getSeconds()).slice(-2); // 초를 가져오고, 앞에 0을 붙임

              const formattedDateTime = `${year}-${month}-${day} ${hour}:${minute}:${second}`; // "yy-MM-dd HH:mm:ss" 형태로 포맷팅합니다.

              console.log(formattedDateTime); // 예시 출력: "23-06-07 16:23:47"
              return formattedDateTime;
          }

          /**
           * READY, UNREADY 및 유저 입장 퇴장 경우에 갱신됨.
           */
          function syncMemberList(isPlaying) {
              fetch('/twenty-game/room/' + currentRoomId + '/members')
                  .then(response => response.json()) // json 형태의 데이터를 자바스크립트 객체로 변환
                  .then(data => {
                      console.log("syncMemberList responseData = {}", data);
                      let memberList = data.memberList;
                      let memberListStr = '';
                      readyUserCount = 0;
                      allUserCount = memberList.length;

                      for (let i = 0; i < memberList.length; i++) {
                          // 결과물 작성
                          memberListStr += memberList[i].username + '(' + (memberList[i].isTwentyGameReady ? 'Ready' : "Unready") + ')' + ', ';

                          if (isPlaying) continue; // 플레이중인경우 후처리 무시

                          // ready 된 유저 수 계산
                          readyUserCount = memberList[i].isTwentyGameReady ? ++readyUserCount : readyUserCount;

                          // 내 순서 결정용 memberOrder 설정
                          myMemberOrder = memberList[i].userId == currentUserId ? i : myMemberOrder;
                      }

                      remainingOrderCount = readyUserCount; // 실 플레이 유저 수 대입 후 -- 해갈것

                      document.getElementById("memberList").innerHTML = memberListStr;
                  });
          }

          function changeReadyBtnStyle(isCurrentUserReady) {
              if (isCurrentUserReady == true) {
                  console.log('change isReady : ' + isCurrentUserReady)
                  // 준비하기(readyBtn) 클릭, 준비됨(unReadyBtn) 으로 변경
                  readyBtn.style.display = 'none';
                  unReadyBtn.style.display = 'block';
              } else {
                  // 준비됨(unReadyBtn) 클릭, 준비하기(readyBTn) 로 변경
                  readyBtn.style.display = 'block';
                  unReadyBtn.style.display = 'none';
              }
          }

          /**
           * 모든 #menuBar 내부 버튼 비활성화
           */
          function disableAllMenuBtn() {
              document.querySelectorAll('#menuBar button').forEach(function (item) {
                  item.disabled = true;
              });
          }

          /**
           * 모든 #menuBar 내부 버튼 활성화
           */
          function enableAllMenuBtn() {
              document.querySelectorAll('#menuBar button').forEach(function (item) {
                  item.disabled = false;
              });
          }


      }); // DOMContentLoaded

  </script>
</head>
<body>
<div class="container">

  <div>
    <h2>Chat WebSocket</h2>
  </div>

  <h4>Room info</h4>
  <ul>
    <li id="roomId" th:text="|id ${chatRoom.id}|" th:data-roomid="${chatRoom.id}">roomId</li>
    <li id="roomName" th:text="|name ${chatRoom.getName}|">roomName</li>
    <li id="memberList"></li>
  </ul>
  <button id="memberListBtn" type="button" class="btn btn-outline-primary">memberList</button>

  <hr>

  <div id="menuBar" class="input-group">
    <button id="unSubscribeBtn" class="btn btn-outline-danger" disabled='true'>Unsubscribe</button>
    <button id="readyBtn" class="btn btn-outline-primary changeReadyBtn" data-toready="true">준비하기</button>
    <button id="unReadyBtn" class="btn btn-outline-success changeReadyBtn" data-toready="false">준비됨</button>
    <button id="startBtn" class="btn btn-outline-secondary" disabled>start</button>
  </div>

  <hr>

  <div id="conversationBox" class="card">
    <div class="card-body">
      <ul id="conversationList" class="list-group">
        <!-- Messages will be dynamically added here -->
      </ul>
    </div>
  </div>

  <div id="inputStatusBox">
    <p id="inputStatus">대기중</p>
  </div>
  <form id="conversationInput" class="input-group" sec:authorize="isAuthenticated()">
    <div class="input-group">
      <input type="text" id="blockSubmit" style="display: none"/>
      <input type="text" id="contentInput" class="form-control" placeholder="채팅 메시지 입력" value=""/>
      <input type="hidden" id="usernameInput" th:value="${#authentication.name}"/>
      <input type="hidden" id="order" value="0"/>
      <input type="hidden" id="userId" th:value="${#authentication.principal.id}">
      <div class="input-group-append">
        <button type="button" id="sendMessageBtn" class="btn btn-primary">Send</button>
      </div>
      <div class="input-group-append">
        <button type="button" id="sendGptMessageBtn" class="btn btn-secondary">SendGpt</button>
      </div>
    </div>
  </form>

</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
</body>
</html>
